---
# @halifax~ id
# uid=20003(toby) gid=100(users) groups=100(users),4(adm),27(sudo),999(sshlogin)
# @halifax~ getent passwd toby
# toby:x:20003:100:Toby Oxborrow <toby@oxborrow.net>:/home/toby:/bin/bash
- name: Ensure user toby exists
  user:
    name: toby
    comment: Toby Oxborrow <toby@oxborrow.net>
    group: users
    groups: adm,sudo,sshlogin
    shell: /bin/bash
    createhome: yes
    state: present
    system: no

- name: Ensure home directory directory permissions
  file:
    path: /home/toby
    mode: 0700

- name: Ensure authorized_keys file is present
  authorized_key:
    user: toby
    key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCjYf9u9mItGujvxv+TTBIPd0gmdUXwcU+J7xvXbVdDDdQ29uo6BtZfWKyTXViTCozxlqdyqhEOJKwXEgZ9Bv24eHnpL9rrbBIqDwXHAoR8WorEQjIJ4PPvAMIizh6dw/B+huvNQG4sdDzdeAllc6w4QjJ2PpcQ66fTVHPb59G9MXvgKcWkptpdkDnSLXa1AXppNI8h1bEBUi5PV0sCM3w0qclUHEXAR2cRbJ1tYE2DLVMLgiprfeudR958ig14EQmBqA0p8whOREn5CqUWe5nbDwd/zqcyDAIsff0YZkM6xq+Zzay8WK+S7FdSNbXGovuOORjXShE2/AkzuU0aSAjF6FCWftBLCG02IbW5EGS6LfD+coo3CVu4mTjQy3efKYSnJJR6K9J4vOn8OwDUnprE+zmvvRRkmqca+N+sk1Sghm+pFnkRnSUHEpP39JylSFSLefGWZ+aE7Go86TBm2q0IsxTz942o1/eRSwR+lRgWEBm8aWxoHnXGXya+8BJ0QKLBXkCeNe0ogB/S99UE/pLKAGfhttBL5azDAoU31Uyq9zFVcKaF0YEFXKwTGz9IcTyS5D9uZB/cf2PLdfCthQ+3BKa8QT1/MyQhSSia3hN+oOYY0pYZ3ES+YEM9HvhFpocEuSB9ebhzEQo2Fc+rQcOvl/kuxHcMqdGfP2O6mGKSUQ== toby@oxborrow.net'
    exclusive: yes
    state: present
    manage_dir: yes

- name: Ensure git is installed
  package:
    name: git
    state: present

- name: Clone dotfiles
  git:
    repo: https://github.com/tobyoxborrow/dotfiles
    remote: origin
    version: HEAD
    clone: yes
    update: no
    dest: /home/toby/.dotfiles
  become: yes
  become_user: toby
  register: clone_dotfiles

- name: Run dotfiles script
  command: /home/toby/.dotfiles/dotfiles.sh
  become: yes
  become_user: toby
  register: dotfiles_sh
  changed_when: dotfiles_sh.stdout != ""
  when: clone_dotfiles|changed
